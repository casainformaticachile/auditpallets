<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>PALLET CHECKED SYSTEM</title>
<link href="https://fonts.googleapis.com/css?family=Oxanium:400,700&amp;display=swap" rel="stylesheet"/>
<style>
    body { min-height: 100vh; margin: 0; font-family: 'Oxanium', Arial, sans-serif; background: #fff; }
    .main-layout { display: flex; flex-direction: row; align-items: flex-start; justify-content: flex-start; width: 100vw; height: 100vh; box-sizing: border-box; padding: 0; }
    .left-panel { flex: 1 1 auto; display: flex; flex-direction: column; align-items: center; margin-top: 35px; min-width: 0; position: relative; }
    .designer-credit { position: absolute; left: 50%; bottom: 8px; transform: translateX(-50%); font-size: 12px; font-family: 'Oxanium', Arial, sans-serif; color: #000; background: none; z-index: 100; user-select: none; pointer-events: none; letter-spacing: 0.3px; text-align: center; width: max-content; min-width: 60%; }
    h1 { margin: 0.5em 0 0.3em 0; text-align: center; font-weight: normal; width: 100%; max-width: 98vw; font-family: 'Oxanium', Arial, sans-serif; font-size: 50px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .form-container { width: 1300px; max-width: 98vw; display: flex; justify-content: center; align-items: center; position: relative; }
    form { display: flex; flex-direction: row; gap: 0.7em; margin: 0.7em 0 0.5em 0; justify-content: center; align-items: center; width: 100%; font-family: 'Oxanium', Arial, sans-serif; }
    input[type="text"] { width: 1300px; height: 300px; padding: 0.4em; border: 2px solid #bbb; border-radius: 8px; font-size: 200px; font-family: 'Oxanium', Arial, sans-serif; text-align: center; box-sizing: border-box; caret-color: #ff0000; transition: background 0.2s; position: relative; z-index: 1; background: #fff; }
    input[type="text"].verde-neon { background: #39ff14; color: #111; transition: background 0.2s; }
    input[type="text"].amarillo-neon { background: #fff600; color: #111; transition: background 0.2s; }
    input[type="text"]:disabled { opacity: 1; }
    .placeholder-feedback { display: none; position: absolute; left: 0; right: 0; top: 0; height: 300px; font-size: 200px; color: #111; font-family: 'Oxanium', Arial, sans-serif; text-align: center; line-height: 300px; pointer-events: none; z-index: 2; background: transparent; white-space: nowrap; user-select: none; }
    .placeholder-feedback.mostrar { display: block; animation: fadeIn 0.16s; }
    @keyframes fadeIn { from { opacity: 0; } to   { opacity: 1; } }
    input[type="text"]::placeholder { font-size: 200px; color: #bbb; text-align: center; font-family: 'Oxanium', Arial, sans-serif; opacity: 1; }
    #es-duplicado { color: #000; font-size: 50px; font-weight: bold; text-align: center; margin: 0.1em 0 0.1em 0; font-family: 'Oxanium', Arial, sans-serif; line-height: 1.1; user-select: none; min-height: 80px; transition: color 0.2s; word-break: break-all; }
    #codigo-mostrado { color: #ff0000; font-size: 200px; font-weight: bold; text-align: center; margin: 0.3em 0 0.1em 0; font-family: 'Oxanium', Arial, sans-serif; line-height: 1; word-break: break-all; max-width: 1300px; overflow-wrap: break-word; min-height: 220px; background: #fff; }
    .right-panel { width: 400px; min-width: 300px; max-width: 40vw; background: #f8fafc; border-left: 2px solid #e4e4e4; min-height: 100vh; padding: 32px 24px 24px 24px; box-sizing: border-box; display: flex; flex-direction: column; align-items: flex-start; position: relative; }
    .right-panel h2 { margin-top: 0; margin-bottom: 0.7em; font-size: 1.25em; font-family: 'Oxanium', Arial, sans-serif; font-weight: normal; color: #111; text-align: left; width: 100%; letter-spacing: 0.5px; }
    #lista { list-style: disc inside; padding: 0; margin: 0; width: 100%; font-family: 'Oxanium', Arial, sans-serif; max-height: 75vh; overflow-y: auto; }
    #lista li { margin-bottom: 0.12em; padding: 0.2em 0.6em 0.2em 0; text-align: left; font-size: 14px; background: none; border: none; word-break: break-all; line-height: 1.1; font-family: 'Oxanium', Arial, sans-serif; transition: background 0.2s, color 0.2s; }
    #lista li.duplicado { background: yellow; color: #222; font-weight: bold; }
    @media (max-width: 1100px) {
      .form-container, input[type="text"], #codigo-mostrado { width: 95vw !important; max-width: 98vw !important; }
      .right-panel { min-width: 190px; width: 35vw; max-width: 98vw; padding: 18px 10px 10px 10px; }
      .designer-credit { left: 50%; transform: translateX(-50%); font-size: 11px; width: max-content; min-width: 60%; }
    }
    @media (max-width: 800px) {
      .main-layout { flex-direction: column; align-items: stretch; height: auto; }
      .left-panel { margin-top: 16px; }
      .right-panel { width: 100vw; min-width: 0; max-width: 100vw; border-left: none; border-top: 2px solid #e4e4e4; min-height: auto; padding: 18px 8px 32px 16px; box-sizing: border-box; margin: 0; }
      h1 { font-size: 7vw; white-space: normal; }
      .designer-credit { left: 50%; bottom: 0px; transform: translateX(-50%); font-size: 10px; width: max-content; min-width: 60%; }
    }
    .right-panel h2 { text-align: center !important; }
    #codigo { margin-top: 50px !important; display: block; margin-left: auto; margin-right: auto; }
    #registeredMsg, #duplicatedMsg { top: 50px !important; }
    #es-duplicado { margin-bottom: 10px !important; }
    #codigo-mostrado { font-size: 250px !important; text-align: center; margin-top: 10px !important; }
</style>
</head>
<body>
  <div class="main-layout">
    <div class="left-panel">
      <h1>PALLET CHECKED SYSTEM</h1>
      <div class="form-container">
        <form autocomplete="off" id="palletForm">
          <input autofocus="" id="codigo" placeholder="SCAN HERE" type="text"/>
          <span class="placeholder-feedback" id="registeredMsg">REGISTERED</span>
          <span class="placeholder-feedback" id="duplicatedMsg">DUPLICATED</span>
        </form>
      </div>
      <div id="es-duplicado"></div>
      <div id="codigo-mostrado"></div>
    </div>
    <div class="right-panel">
      <h2>PALLETS CHECKED TODAY</h2>
      <ul id="lista"></ul>
      <div class="designer-credit">Designed &amp; Developed by Mentes Inquietas 2025</div>
    </div>
  </div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('palletForm');
    const lista = document.getElementById('lista');
    const codigoInput = document.getElementById('codigo');
    const codigoMostrado = document.getElementById('codigo-mostrado');
    const esDuplicadoDiv = document.getElementById('es-duplicado');
    const registeredMsg = document.getElementById('registeredMsg');
    const duplicatedMsg = document.getElementById('duplicatedMsg');

    let palletsHoy = [];
    let ultimoDuplicado = null;
    let palletsHoyData = [];
    let timerShowMsg = null;
    let timerDelayMsg = null;

    // Mostrar fecha en US/Pacific siempre
    function formatFecha(fechaStr) {
      const d = new Date(fechaStr + 'Z');
      if (isNaN(d.getTime())) return fechaStr;
      return d.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' });
    }
    // ¿Es hoy en US/Pacific?
    function esHoy(fechaStr) {
      const d = new Date(fechaStr + 'Z');
      const pacific = d.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' });
      const hoyPacific = new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' });
      const [m1, d1, y1] = pacific.split(',')[0].split('/');
      const [m2, d2, y2] = hoyPacific.split(',')[0].split('/');
      return m1 === m2 && d1 === d2 && y1 === y2;
    }
    function cargarPallets() {
      fetch('/api/pallets')
        .then(res => res.json())
        .then(data => {
          lista.innerHTML = '';
          const hoy = data.filter(item => esHoy(item.fecha));
          hoy.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
          palletsHoy = hoy.map(item => item.codigo);
          palletsHoyData = hoy;
          hoy.forEach(item => {
            const li = document.createElement('li');
            li.textContent = `Pallet: ${item.codigo}   |   Date: ${formatFecha(item.fecha)}`;
            if (ultimoDuplicado && item.codigo === ultimoDuplicado) {
              li.classList.add('duplicado');
              setTimeout(() => { li.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 100);
            }
            lista.appendChild(li);
          });
        });
    }
    function mostrarDuplicado(codigo, esDuplicado) {
      if (!codigo) { esDuplicadoDiv.textContent = ""; ultimoDuplicado = null; return; }
      if (esDuplicado) {
        const found = palletsHoyData.find(p => p.codigo === codigo);
        const fecha = found ? formatFecha(found.fecha) : "";
        esDuplicadoDiv.textContent = `PALLET SCAN DUPLICATED: ${fecha}`;
        ultimoDuplicado = codigo;
      } else {
        const now = formatFecha(new Date().toISOString().slice(0,19));
        esDuplicadoDiv.textContent = `PALLET SCAN REGISTERED: ${now}`;
        ultimoDuplicado = null;
      }
    }
    function bloquearInput() {
      codigoInput.disabled = true;
    }
    function desbloquearInput() {
      codigoInput.disabled = false;
      codigoInput.focus();
    }
    function limpiarMensajes() {
      registeredMsg.classList.remove('mostrar');
      duplicatedMsg.classList.remove('mostrar');
      codigoInput.classList.remove('verde-neon', 'amarillo-neon');
      codigoInput.setAttribute('placeholder', 'SCAN HERE');
    }

    // Código grande rojo nunca desaparece hasta otro escaneo o recarga
    function mostrarCodigoGrande(codigo) {
      codigoMostrado.textContent = codigo;
    }

    // Mensaje REGISTERED/DUPLICATED aparece tras 0.25s y se queda 4.75s (total 5s)
    function mostrarFeedback(estado) {
      limpiarMensajes();
      bloquearInput();
      codigoInput.setAttribute('placeholder', '');
      // Input color inmediato
      if (estado === 'registered') {
        codigoInput.classList.add('verde-neon');
      } else if (estado === 'duplicated') {
        codigoInput.classList.add('amarillo-neon');
      }
      // Mostrar mensaje con 0.25s de retardo, y quitar todo tras 5s
      timerDelayMsg = setTimeout(() => {
        if (estado === 'registered') {
          registeredMsg.classList.add('mostrar');
        } else if (estado === 'duplicated') {
          duplicatedMsg.classList.add('mostrar');
        }
        timerShowMsg = setTimeout(() => {
          limpiarMensajes();
          desbloquearInput();
        }, 4750);
      }, 250);
    }

    form.onsubmit = function(e) {
      e.preventDefault();
      if (timerShowMsg) clearTimeout(timerShowMsg);
      if (timerDelayMsg) clearTimeout(timerDelayMsg);

      const codigo = codigoInput.value.trim();
      if (!codigo) return;
      const esDuplicado = palletsHoy.includes(codigo);

      mostrarCodigoGrande(codigo);
      mostrarDuplicado(codigo, esDuplicado);

      if (esDuplicado) {
        mostrarFeedback('duplicated');
        cargarPallets();
        form.reset();
        return;
      }
      mostrarFeedback('registered');
      fetch('/api/pallets', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ codigo })
      })
      .then(res => {
        if (res.status === 409) { // Duplicado detectado por backend
          mostrarDuplicado(codigo, true);
          mostrarFeedback('duplicated');
          cargarPallets();
          form.reset();
          return Promise.reject('duplicado');
        }
        return res.json();
      })
      .then(() => {
        ultimoDuplicado = null;
        cargarPallets();
        form.reset();
      })
      .catch(err => {
        if (err !== 'duplicado') {
          alert('Error inesperado guardando pallet');
        }
      });
    };
    codigoInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        form.requestSubmit();
      }
    });
    cargarPallets();
    codigoInput.focus();
});
// Opcional: recarga la página cada 6 horas para asegurar actualización
setTimeout(() => { location.reload(); }, 6 * 60 * 60 * 1000);
</script>
</body>
</html>