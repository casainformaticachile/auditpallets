<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>PALLET CHECKED SYSTEM</title>
<link href="https://fonts.googleapis.com/css?family=Oxanium:400,700&amp;display=swap" rel="stylesheet"/>
<!-- ...estilos igual que antes... -->
<style>
/* Copia aquí los estilos CSS completos del archivo original */
</style>
</head>
<body>
<!-- ...estructura HTML igual que antes... -->
<script>
    const form = document.getElementById('palletForm');
    const lista = document.getElementById('lista');
    const codigoInput = document.getElementById('codigo');
    const codigoMostrado = document.getElementById('codigo-mostrado');
    const esDuplicadoDiv = document.getElementById('es-duplicado');
    const registeredMsg = document.getElementById('registeredMsg');
    const duplicatedMsg = document.getElementById('duplicatedMsg');

    // Mantiene los pallets de hoy en memoria para control de duplicado
    let palletsHoy = [];
    let ultimoDuplicado = null;
    let timerVerde = null;
    let timerAmarillo = null;
    let timerRegistered = null;
    let timerDuplicated = null;
    let timerDisabled = null;

    function formatFecha(fechaStr) {
      const d = new Date(fechaStr);
      if (isNaN(d.getTime())) return fechaStr;
      const pad = n => n.toString().padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    function getNowFormatted() {
      const d = new Date();
      const pad = n => n.toString().padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    function esHoy(fechaStr) {
      const hoy = new Date();
      const [anio, mes, dia] = [
        hoy.getFullYear(),
        hoy.getMonth() + 1,
        hoy.getDate()
      ];
      const [anioF, mesF, diaF] = fechaStr.split(' ')[0].split('-').map(Number);
      return anio === anioF && mes === mesF && dia === diaF;
    }
    function cargarPallets() {
      fetch('/api/pallets')
        .then(res => res.json())
        .then(data => {
          lista.innerHTML = '';
          const hoy = data.filter(item => esHoy(item.fecha));
          hoy.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
          palletsHoy = hoy.map(item => item.codigo);
          palletsHoyData = hoy;
          hoy.forEach(item => {
            const li = document.createElement('li');
            li.textContent = `Pallet: ${item.codigo}   |   Date: ${item.fecha}`;
            if (ultimoDuplicado && item.codigo === ultimoDuplicado) {
              li.classList.add('duplicado');
              setTimeout(() => {
                li.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }, 100);
            }
            lista.appendChild(li);
          });
        });
    }
    let palletsHoyData = [];
    function mostrarDuplicado(codigo, esDuplicado) {
      if (!codigo) {
        esDuplicadoDiv.textContent = "";
        ultimoDuplicado = null;
        return;
      }
      if (esDuplicado) {
        const found = palletsHoyData.find(p => p.codigo === codigo);
        const fecha = found ? formatFecha(found.fecha) : "";
        esDuplicadoDiv.textContent = `PALLET SCAN DUPLICATED: ${fecha}`;
        ultimoDuplicado = codigo;
      } else {
        const now = getNowFormatted();
        esDuplicadoDiv.textContent = `PALLET SCAN REGISTERED: ${now}`;
        ultimoDuplicado = null;
      }
    }
    function ponerVerdeNeonYBloquearInput() {
      codigoInput.classList.add('verde-neon');
      codigoInput.classList.remove('amarillo-neon');
      codigoInput.disabled = true;
      if (timerVerde) clearTimeout(timerVerde);
      if (timerDisabled) clearTimeout(timerDisabled);
      timerVerde = setTimeout(() => {
        codigoInput.classList.remove('verde-neon');
      }, 5000);
      timerDisabled = setTimeout(() => {
        codigoInput.disabled = false;
        codigoInput.focus();
      }, 5000);
    }
    function ponerAmarilloNeonYBloquearInput() {
      codigoInput.classList.add('amarillo-neon');
      codigoInput.classList.remove('verde-neon');
      codigoInput.disabled = true;
      if (timerAmarillo) clearTimeout(timerAmarillo);
      if (timerDisabled) clearTimeout(timerDisabled);
      timerAmarillo = setTimeout(() => {
        codigoInput.classList.remove('amarillo-neon');
      }, 5000);
      timerDisabled = setTimeout(() => {
        codigoInput.disabled = false;
        codigoInput.focus();
      }, 5000);
    }
    function mostrarRegisteredMsg() {
      codigoInput.setAttribute('placeholder', '');
      registeredMsg.classList.add('mostrar');
      duplicatedMsg.classList.remove('mostrar');
      if (timerRegistered) clearTimeout(timerRegistered);
      timerRegistered = setTimeout(() => {
        registeredMsg.classList.remove('mostrar');
        codigoInput.setAttribute('placeholder', 'SCAN HERE');
      }, 5000);
    }
    function mostrarDuplicatedMsg() {
      codigoInput.setAttribute('placeholder', '');
      duplicatedMsg.classList.add('mostrar');
      registeredMsg.classList.remove('mostrar');
      if (timerDuplicated) clearTimeout(timerDuplicated);
      timerDuplicated = setTimeout(() => {
        duplicatedMsg.classList.remove('mostrar');
        codigoInput.setAttribute('placeholder', 'SCAN HERE');
      }, 5000);
    }
    form.onsubmit = function(e) {
      e.preventDefault();
      const codigo = codigoInput.value.trim();
      if (!codigo) return;
      codigoMostrado.textContent = codigo;
      const esDuplicado = palletsHoy.includes(codigo);
      mostrarDuplicado(codigo, esDuplicado);
      if (esDuplicado) {
        ponerAmarilloNeonYBloquearInput();
        mostrarDuplicatedMsg();
        cargarPallets();
        form.reset();
        return;
      }
      ponerVerdeNeonYBloquearInput();
      mostrarRegisteredMsg();

      // Cambia aquí para manejar duplicados por el backend:
      fetch('/api/pallets', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ codigo })
      })
      .then(res => {
        if (res.status === 409) {
          mostrarDuplicado(codigo, true);
          ponerAmarilloNeonYBloquearInput();
          mostrarDuplicatedMsg();
          cargarPallets();
          form.reset();
          return Promise.reject('duplicado');
        }
        return res.json();
      })
      .then(() => {
        ultimoDuplicado = null;
        cargarPallets();
        form.reset();
      })
      .catch(err => {
        if (err !== 'duplicado') {
          alert('Error inesperado guardando pallet');
        }
      });
    };
    codigoInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        form.requestSubmit();
      }
    });
    cargarPallets();
    codigoInput.focus();
</script>
<script>
  // Recarga la página automáticamente cada 6 horas
  setTimeout(() => {
    location.reload();
  }, 6 * 60 * 60 * 1000);
</script>
</body>
</html>