
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AuditPallets</title>
  <style>
    body {
      background-color: #000;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    #logo {
      max-width: 150px;
      margin-top: 20px;
    }
    h1 {
      font-size: 24px;
      margin-top: 10px;
    }
    #scanner-box {
      border: 3px dashed white;
      padding: 30px;
      margin: 30px auto;
      width: 60%;
      max-width: 600px;
      position: relative;
    }
    #codigo {
      width: 100%;
      padding: 20px;
      font-size: 36px;
      background-color: black;
      color: white;
      border: none;
      text-align: center;
    }
    #codigo:focus {
      outline: none;
      border: 2px solid #39FF14;
    }
    #registered {
      display: none;
      font-size: 48px;
      margin-top: 20px;
      padding: 15px;
      border-radius: 10px;
      font-weight: bold;
    }
    #ultimo {
      margin-top: 40px;
    }
    #ultimo span {
      font-size: 50px;
      font-weight: bold;
      color: red;
      display: block;
      margin-top: 10px;
    }
    #mensajeDuplicado {
      font-size: 24px;
      color: yellow;
      margin-top: 10px;
    }
    #pallets-lista {
      list-style: none;
      padding: 0;
      margin-top: 30px;
      max-height: 300px;
      overflow-y: auto;
      text-align: left;
    }
    #pallets-lista li {
      padding: 5px 0;
      border-bottom: 1px solid #555;
    }
  </style>
</head>
<body>
  <img id="logo" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUA..." alt="Logo" />
  <h1>SCAN AUDITED PALLET TAG</h1>

  <div id="scanner-box">
    <input type="text" id="codigo" placeholder="SCAN HERE" autofocus autocomplete="off" />
    <div id="registered"></div>
  </div>

  <div id="ultimo">
    <div>LAST AUDITED PALLET:</div>
    <span id="ultimoCodigo">None</span>
    <div id="mensajeDuplicado"></div>
  </div>

  <h2>Audited Pallets Today:</h2>
  <ul id="pallets-lista"></ul>

  <script>
    function esHoy(fechaStr) {
      const hoy = new Date();
      const fecha = new Date(fechaStr);
      return fecha.toDateString() === hoy.toDateString();
    }

    function cargarPalletsDeHoy() {
      fetch('/hoy')
        .then((res) => res.json())
        .then((data) => {
          const lista = document.getElementById('pallets-lista');
          lista.innerHTML = '';
          const ordenados = data.sort((a, b) => a.codigo.localeCompare(b.codigo));
          ordenados.forEach((p) => {
            const li = document.createElement('li');
            li.textContent = `${p.codigo} - ${new Date(p.fecha).toLocaleString()}`;
            lista.appendChild(li);
          });
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('codigo');
      const registeredDiv = document.getElementById('registered');
      const ultimo = document.getElementById('ultimoCodigo');
      const mensajeDuplicado = document.getElementById('mensajeDuplicado');

      cargarPalletsDeHoy();

      input.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter') {
          const codigo = input.value.trim();
          if (!codigo) return;

          const todos = await fetch('/todos').then((r) => r.json());
          const duplicado = todos.find((p) => p.codigo === codigo);

          if (duplicado) {
            // DUPLICADO
            input.style.backgroundColor = 'yellow';
            input.style.color = 'black';
            input.value = '';
            registeredDiv.textContent = 'DUPLICATED';
            registeredDiv.style.backgroundColor = 'yellow';
            registeredDiv.style.color = 'black';
            registeredDiv.style.display = 'block';
            ultimo.textContent = codigo;
            mensajeDuplicado.textContent = `PALLET AUDITED AT ${new Date(duplicado.fecha).toLocaleString()}`;

            setTimeout(() => {
              registeredDiv.style.display = 'none';
              mensajeDuplicado.textContent = '';
              input.style.backgroundColor = 'black';
              input.style.color = 'white';
            }, 5000);
            return;
          }

          // NUEVO PALLET
          fetch('/guardar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ codigo }),
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.status === 'ok') {
                registeredDiv.textContent = 'REGISTERED';
                registeredDiv.style.backgroundColor = '#39FF14';
                registeredDiv.style.color = 'black';
                registeredDiv.style.display = 'block';
                ultimo.textContent = codigo;
                mensajeDuplicado.textContent = '';
                cargarPalletsDeHoy();
                setTimeout(() => {
                  registeredDiv.style.display = 'none';
                }, 2000);
              }
              input.value = '';
            });
        }
      });
    });
  </script>
</body>
</html>
